# Merged tags from k8s_audit_rules.yaml

#
# Copyright (C) 2019 The Falco Authors.
#
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
- required_engine_version: 8

# Like always_true/always_false, but works with k8s audit events
- macro: k8s_audit_always_true
  condition: (jevt.rawtime exists)

- macro: k8s_audit_never_true
  condition: (jevt.rawtime=0)

# Generally only consider audit events once the response has completed
- list: k8s_audit_stages
  items: ["ResponseComplete"]

# Generally exclude users starting with "system:"
- macro: non_system_user
  condition: (not ka.user.name startswith "system:")

# This macro selects the set of Audit Events used by the below rules.
- macro: kevt
  condition: (jevt.value[/stage] in (k8s_audit_stages))

- macro: kevt_started
  condition: (jevt.value[/stage]=ResponseStarted)

# If you wish to restrict activity to a specific set of users, override/append to this list.
# users created by kops are included
- list: vertical_pod_autoscaler_users
  items: ["vpa-recommender", "vpa-updater"]

- list: allowed_k8s_users
  items: ["minikube", "minikube-user", "kubelet", "kops", "admin", "kube", "kube-proxy", "kube-apiserver-healthcheck", "kubernetes-admin", vertical_pod_autoscaler_users, cluster-autoscaler, "system:addon-manager", "cloud-controller-manager", "eks:certificate-controller", "eks:fargate-scheduler", "eks:k8s-metrics"]

- rule: Disallowed K8s User
  desc: Detect any k8s operation by users outside of an allowed set of users.
  condition: kevt and non_system_user
  exceptions:
  - name: user_names
    fields: ka.user.name
    comps: in
    values: [allowed_k8s_users]
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: group_names
    fields: [ka.user.groups]
    comps: [intersects]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  - name: user_name_target_resource
    fields: [ka.user.name, ka.target.resource]
    comps: [in, in]
  - name: user_name_target_resource_prefix
    fields: [ka.user.name, ka.target.resource]
    comps: [in, startswith]
  output: K8s Operation performed by user not in allowed list of users (user=%ka.user.name target=%ka.target.name/%ka.target.resource verb=%ka.verb uri=%ka.uri resp=%ka.response.code)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC5.2, SOC2_CC6.1, PCI, PCI_DSS, PCI_DSS_6.4.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.13.3, NIST_800-190, NIST_800-190_3.3.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-17, NIST_800-53_SC-2, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HIPAA_164.312(a), HITRUST, HITRUST_CSF, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.n, HITRUST_CSF_01.s, HITRUST_CSF_01.y, HITRUST_CSF_09.j, HITRUST_CSF_09.k, HITRUST_CSF_09.m, HITRUST_CSF_09.s, HITRUST_CSF_09.y, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1078_valid_accounts, MITRE_TA0005_defense_evasion]

# In a local/user rules file, you could override this macro to
# explicitly enumerate the container images that you want to run in
# your environment. In this main falco rules file, there isn't any way
# to know all the containers that can run, so any container is
# allowed, by using the always_true macro. In the overridden macro, the condition
# would look something like (ka.req.pod.containers.image.repository in (my-repo/my-image))
- macro: allowed_k8s_containers
  condition: (k8s_audit_always_true)

- macro: response_successful
  condition: (ka.response.code startswith 2)

- macro: kcreate
  condition: ka.verb=create

- macro: kmodify
  condition: (ka.verb in (create,update,patch))

- macro: kdelete
  condition: ka.verb=delete

- macro: pod
  condition: ka.target.resource=pods and not ka.target.subresource exists

- macro: pod_subresource
  condition: ka.target.resource=pods and ka.target.subresource exists

- macro: deployment
  condition: ka.target.resource=deployments

- macro: service
  condition: ka.target.resource=services

- macro: configmap
  condition: ka.target.resource=configmaps

- macro: namespace
  condition: ka.target.resource=namespaces

- macro: serviceaccount
  condition: ka.target.resource=serviceaccounts

- macro: clusterrole
  condition: ka.target.resource=clusterroles

- macro: clusterrolebinding
  condition: ka.target.resource=clusterrolebindings

- macro: role
  condition: ka.target.resource=roles

- macro: secret
  condition: ka.target.resource=secrets

- macro: health_endpoint
  condition: ka.uri=/healthz

- rule: Create Disallowed Pod
  desc: >
    Detect an attempt to start a pod with a container image outside of a list of allowed images.
  condition: kevt and pod and kcreate and not allowed_k8s_containers
  exceptions:
  - name: image_repos
    fields: ka.req.pod.containers.image.repository
    comps: in
  output: Pod started with container not in allowed list (user=%ka.user.name pod=%ka.resp.name ns=%ka.target.namespace images=%ka.req.pod.containers.image)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-190, NIST_800-190_3.4.5, NIST_800-53, NIST_800-53_AU-6(8), HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), MITRE, MITRE_T1610_deploy_container, MITRE_TA0002_execution]

- rule: Create Privileged Pod
  desc: >
    Detect an attempt to start a pod with a privileged container
  condition: kevt and pod and kcreate and ka.req.pod.containers.privileged intersects (true)
  exceptions:
  - name: image_repos
    fields: ka.req.pod.containers.image.repository
    comps: in
    values: [falco_privileged_images]
  - name: image_repo_suffix
    fields: [ka.req.pod.containers.image.repository]
    comps: [endswith]
  - name: namespaces
    fields: ka.target.namespace
    comps: in
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  output: Pod started with privileged container (user=%ka.user.name pod=%ka.resp.name ns=%ka.target.namespace images=%ka.req.pod.containers.image)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.5, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.3, NIST, NIST_800-53, NIST_800-53_AC-6, NIST_800-53_AC-6(9), NIST_800-53_AC-6(10), NIST_800-53_CM-3, NIST_800-53_SI-4, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.x, HITRUST_CSF_01.y, HITRUST_CSF_03.d, HITRUST_CSF_05.i, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_09.i, HITRUST_CSF_09.k, HITRUST_CSF_09.m, HITRUST_CSF_10.h, HITRUST_CSF_10.j, HITRUST_CSF_10.k, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1609_container_administration_command, MITRE_TA0002_execution]

- macro: sensitive_vol_mount
  condition: >
    (ka.req.pod.volumes.hostpath intersects (/proc, /var/run/docker.sock, /, /etc, /root, /var/run/crio/crio.sock, /home/admin, /var/lib/kubelet, /var/lib/kubelet/pki, /etc/kubernetes, /etc/kubernetes/manifests))

- rule: Create Sensitive Mount Pod
  desc: >
    Detect an attempt to start a pod with a volume from a sensitive host directory (i.e. /proc).
    Exceptions are made for known trusted images.
  condition: kevt and pod and kcreate and sensitive_vol_mount
  exceptions:
  - name: image_repos
    fields: ka.req.pod.containers.image.repository
    comps: in
    values: [falco_sensitive_mount_images]
  - name: user_name_target_name_prefix
    fields: [ka.user.name,ka.target.namespace]
    comps: [startswith,=]
  - name: image_repo_suffix
    fields: [ka.req.pod.containers.image.repository]
    comps: [endswith]
  - name: image_repos_ns
    fields: [ka.req.pod.containers.image, ka.target.namespace]
    comps: [in, in]
  - name: image_repos_prefix_ns
    fields: [ka.req.pod.containers.image, ka.target.namespace]
    comps: [startswith, in]
  - name: image_repos_ns_contains
    fields: [ka.req.pod.containers.image, ka.target.namespace]
    comps: [contains, contains]
  output: Pod started with sensitive mount (user=%ka.user.name pod=%ka.resp.name ns=%ka.target.namespace images=%ka.req.pod.containers.image volumes=%jevt.value[/requestObject/spec/volumes])
  priority: WARNING
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.5, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.3, NIST, NIST_800-190, NIST_800-190_3.3, NIST_800-190_3.5.5, NIST_800-53, NIST_800-53_AC-6, NIST_800-53_AC-6(9), NIST_800-53_AC-6(10), NIST_800-53_CM-3, NIST_800-53_SI-4, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.x, HITRUST_CSF_01.y, HITRUST_CSF_03.d, HITRUST_CSF_05.i, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_09.i, HITRUST_CSF_09.k, HITRUST_CSF_09.m, HITRUST_CSF_10.h, HITRUST_CSF_10.j, HITRUST_CSF_10.k, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1609_container_administration_command, MITRE_T1611_escape_to_host, MITRE_TA0002_execution, MITRE_TA0004_privilege_escalation]

# These container images are allowed to run with hostnetwork=true
- list: falco_hostnetwork_images
  items: [gcr.io/google-containers/prometheus-to-sd, gcr.io/projectcalico-org/typha, gcr.io/projectcalico-org/node, gke.gcr.io/gke-metadata-server, gke.gcr.io/kube-proxy, gke.gcr.io/netd-amd64, k8s.gcr.io/ip-masq-agent-amd64 k8s.gcr.io/prometheus-to-sd, quay.io/sysdig/agent]

# Corresponds to K8s CIS Benchmark 1.7.4
- rule: Create HostNetwork Pod
  desc: Detect an attempt to start a pod using the host network.
  condition: kevt and pod and kcreate and ka.req.pod.host_network intersects (true)
  exceptions:
  - name: image_repos
    fields: ka.req.pod.containers.image.repository
    comps: in
    values: [falco_hostnetwork_images]
  - name: image_repo_suffix
    fields: [ka.req.pod.containers.image.repository]
    comps: [endswith]
  - name: namespaces
    fields: ka.target.namespace
    comps: in
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  - name: users_contains
    fields: [ka.user.name]
    comps: [contains]
  output: Pod started using host network (user=%ka.user.name pod=%ka.resp.name ns=%ka.target.namespace images=%ka.req.pod.containers.image)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.1, SOC2_CC6.6, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.3, NIST_800-171_3.13.1, NIST_800-171_3.13.2, NIST_800-171_3.13.5, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-53, NIST_800-53_AC-4, NIST_800-53_AC-17, NIST_800-53_SI-4, NIST_800-53_AC-17(1), NIST_800-53_AC-17(3), NIST_800-53_SC-7, NIST_800-53_SC-7(3), ISO, ISO_27001, ISO_27001_A.9.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.m, HITRUST_CSF_01.n, HITRUST_CSF_01.o, HITRUST_CSF_01.x, HITRUST_CSF_01.y, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.m, HITRUST_CSF_09.s, HITRUST_CSF_09.z, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1609_container_administration_command, MITRE_TA0002_execution]

- macro: user_known_node_port_service
  condition: (k8s_audit_never_true)

- rule: Create NodePort Service
  desc: >
    Detect an attempt to start a service with a NodePort service type
  condition: kevt and service and kcreate and ka.req.service.type=NodePort and not user_known_node_port_service
  exceptions:
  - name: services
    fields: [ka.target.namespace, ka.target.name]
  - name: users
    fields: [ka.target.namespace, ka.user.name]
    comps: [in, in]
  output: NodePort Service Created (user=%ka.user.name service=%ka.target.name ns=%ka.target.namespace ports=%ka.req.service.ports)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.1, SOC2_CC6.6, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.3, NIST_800-171_3.13.1, NIST_800-171_3.13.2, NIST_800-171_3.13.5, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-53, NIST_800-53_AC-4, NIST_800-53_AC-17, NIST_800-53_SI-4, NIST_800-53_AC-17(1), NIST_800-53_AC-17(3), NIST_800-53_SC-7, NIST_800-53_SC-7(3), ISO, ISO_27001, ISO_27001_A.9.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.m, HITRUST_CSF_01.n, HITRUST_CSF_01.o, HITRUST_CSF_01.x, HITRUST_CSF_01.y, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.m, HITRUST_CSF_09.s, HITRUST_CSF_09.z, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1609_container_administration_command, MITRE_TA0002_execution]

- macro: contains_private_credentials
  condition: >
    (ka.req.configmap.obj contains "aws_access_key_id" or
     ka.req.configmap.obj contains "aws-access-key-id" or
     ka.req.configmap.obj contains "aws_s3_access_key_id" or
     ka.req.configmap.obj contains "aws-s3-access-key-id" or
     ka.req.configmap.obj contains "password" or
     ka.req.configmap.obj contains "passphrase")

- rule: Create/Modify Configmap With Private Credentials
  desc: >
    Detect creating/modifying a configmap containing a private credential (aws key, password, etc.)
  condition: kevt and configmap and kmodify and contains_private_credentials
  exceptions:
  - name: configmaps
    fields: [ka.target.namespace, ka.req.configmap.name]
  output: K8s configmap with private credential (user=%ka.user.name verb=%ka.verb configmap=%ka.req.configmap.name namespace=%ka.target.namespace)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.3, SOC2_CC6.7, NIST, NIST_800-171, NIST_800-171_3.13.4, NIST_800-53, NIST_800-53_CA-9, NIST_800-53_SC-4, HITRUST, HITRUST_CSF, HITRUST_CSF_01.w, HITRUST_CSF_09.w, MITRE, MITRE_T1552_unsecured_credentials, MITRE_TA0006_credential_access]

# Corresponds to K8s CIS Benchmark, 1.1.1.
- rule: Anonymous Request Allowed
  desc: >
    Detect any request made by the anonymous user that was allowed
  condition: kevt and ka.user.name=system:anonymous and ka.auth.decision="allow" and not health_endpoint
  exceptions:
  - name: user_names
    fields: ka.user.name
    comps: in
  output: Request by anonymous user allowed (user=%ka.user.name verb=%ka.verb uri=%ka.uri reason=%ka.auth.reason))
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC5.2, SOC2_CC6.1, PCI, PCI_DSS, PCI_DSS_6.5.8, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.5, NIST_800-190, NIST_800-190_3.3.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-6, NIST_800-53_AC-6(1), NIST_800-53_AC-6(3), NIST_800-53_AC-6(5), NIST_800-53_AC-6(6), NIST_800-53_AC-17, NIST_800-53_CM-7(6), NIST_800-53_AC-14, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), FedRAMP_AC-6(1), FedRAMP_AC-6(3), ISO, ISO_27001, ISO_27001_A.6.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(c), HIPAA_164.312(e), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.n, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.y, HITRUST_CSF_05.i, HITRUST_CSF_06.j, HITRUST_CSF_09.m, HITRUST_CSF_09.s, HITRUST_CSF_10.j, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

# Roughly corresponds to K8s CIS Benchmark, 1.1.12. In this case,
# notifies an attempt to exec/attach to a privileged container.

# Ideally, we'd add a more stringent rule that detects attaches/execs
# to a privileged pod, but that requires the engine for k8s audit
# events to be stateful, so it could know if a container named in an
# attach request was created privileged or not. For now, we have a
# less severe rule that detects attaches/execs to any pod.
#
# For the same reason, you can't use things like image names/prefixes,
# as the event that creates the pod (which has the images) is a
# separate event than the actual exec/attach to the pod.

- macro: user_known_exec_pod_activities
  condition: (k8s_audit_never_true)

- rule: Attach/Exec Pod
  desc: >
    Detect any attempt to attach/exec to a pod
  condition: kevt_started and pod_subresource and kcreate and ka.target.subresource in (exec,attach) and not user_known_exec_pod_activities
  exceptions:
  - name: user_names
    fields: ka.user.name
    comps: in
  - name: group_names
    fields: [ka.user.groups]
    comps: [intersects]
  - name: subresources
    fields: [ka.target.namespace, ka.target.subresource]
    comps: [in, in]
  output: Attach/Exec to pod (user=%ka.user.name pod=%ka.target.name ns=%ka.target.namespace action=%ka.target.subresource command=%ka.uri.param[command])
  priority: NOTICE
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.1, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-17, NIST_800-53_AU-2, NIST_800-53_AC-2(4), FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.n, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.y, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.m, HITRUST_CSF_09.s, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1610_deploy_container, MITRE_TA0002_execution]

- macro: user_known_pod_debug_activities
  condition: (k8s_audit_never_true)

# Only works when feature gate EphemeralContainers is enabled
# Definining empty exceptions just to avoid warnings. There isn't any
#  great exception for this kind of object, as you'd expect the images
#  to vary wildly.
- rule: EphemeralContainers Created
  desc: >
    Detect any ephemeral container created
  condition: kevt and pod_subresource and kmodify and ka.target.subresource in (ephemeralcontainers) and not user_known_pod_debug_activities
  exceptions:
  output: Ephemeral container is created in pod (user=%ka.user.name pod=%ka.target.name ns=%ka.target.namespace ephemeral_container_name=%jevt.value[/requestObject/ephemeralContainers/0/name] ephemeral_container_image=%jevt.value[/requestObject/ephemeralContainers/0/image])
  priority: NOTICE
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.1, PCI, PCI_DSS, PCI_DSS_10.1, PCI_DSS_10.2.1, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-53, NIST_800-53_AC-17, NIST_800-53_AU-6, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, FedRAMP_AU-6, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.b, HITRUST_CSF_01.i, HITRUST_CSF_01.j, HITRUST_CSF_01.n, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.y, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.m, HITRUST_CSF_09.s, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1036_masquerading, MITRE_TA0005_defense_evasion]

# In a local/user rules fie, you can append to this list to add additional allowed namespaces
- list: allowed_namespaces
  items: [kube-system, kube-public, default]

- rule: Create Disallowed Namespace
  desc: Detect any attempt to create a namespace outside of a set of known namespaces
  condition: kevt and namespace and kcreate
  exceptions:
  - name: services
    fields: ka.target.name
    comps: in
    values: [allowed_namespaces]
  output: Disallowed namespace created (user=%ka.user.name ns=%ka.target.name)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-53, NIST_800-53_AU-6(8), HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), MITRE, MITRE_T1036_masquerading, MITRE_TA0005_defense_evasion]

# Only defined for backwards compatibility. Use the more specific
# user_allowed_kube_namespace_image_list instead.
- list: user_trusted_image_list
  items: []

- list: user_allowed_kube_namespace_image_list
  items: [user_trusted_image_list]

# Only defined for backwards compatibility. Use the more specific
# allowed_kube_namespace_image_list instead.
- list: k8s_image_list
  items: []

- list: allowed_kube_namespace_image_list
  items: [gcr.io/google-containers/prometheus-to-sd, gcr.io/projectcalico-org/node, gke.gcr.io/addon-resizer, gke.gcr.io/heapster, gke.gcr.io/gke-metadata-server, k8s.gcr.io/ip-masq-agent-amd64, k8s.gcr.io/kube-apiserver, gke.gcr.io/kube-proxy, gke.gcr.io/netd-amd64, k8s.gcr.io/addon-resizer k8s.gcr.io/prometheus-to-sd, k8s.gcr.io/k8s-dns-dnsmasq-nanny-amd64, k8s.gcr.io/k8s-dns-kube-dns-amd64, k8s.gcr.io/k8s-dns-sidecar-amd64, k8s.gcr.io/metrics-server-amd64, kope/kube-apiserver-healthcheck, k8s_image_list]

- macro: allowed_kube_namespace_pods
  condition: (ka.req.pod.containers.image.repository in (user_allowed_kube_namespace_image_list) or ka.req.pod.containers.image.repository in (allowed_kube_namespace_image_list))

# Detect any new pod created in the kube-system namespace
- rule: Pod Created in Kube Namespace
  desc: Detect any attempt to create a pod in the kube-system or kube-public namespaces
  condition: >
    kevt and pod and kcreate
    and ka.target.namespace in (kube-system, kube-public)
    and not ka.user.name startswith "system:"
    and not allowed_kube_namespace_pods
  output: Pod created in kube namespace (user=%ka.user.name pod=%ka.resp.name ns=%ka.target.namespace images=%ka.req.pod.containers.image)
  exceptions:
  - name: images
    fields: ka.req.pod.containers.image.repository
    comps: in
    values: [user_allowed_kube_namespace_image_list, allowed_kube_namespace_image_list]
  - name: image_suffix
    fields: [ka.req.pod.containers.image.repository]
    comps: [endswith]
  - name: users
    fields: ka.user.name
    comps: in
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.3, NIST_800-53, NIST_800-53_AC-6(9), NIST_800-53_AC-6(10), NIST_800-53_CM-3, NIST_800-53_SI-4, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.x, HITRUST_CSF_03.d, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_09.i, HITRUST_CSF_09.k, HITRUST_CSF_09.m, HITRUST_CSF_10.h, HITRUST_CSF_10.k, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1036_masquerading, MITRE_T1609_container_administration_command, MITRE_TA0002_execution, MITRE_TA0005_defense_evasion]

- list: user_known_sa_list
  items: []

- list: known_sa_list
  items: [
    coredns,
    coredns-autoscaler,
    cronjob-controller,
    daemon-set-controller,
    deployment-controller,
    disruption-controller,
    endpoint-controller,
    endpointslice-controller,
    endpointslicemirroring-controller,
    generic-garbage-collector,
    horizontal-pod-autoscaler,
    job-controller,
    namespace-controller,
    node-controller,
    persistent-volume-binder,
    pod-garbage-collector,
    pv-protection-controller,
    pvc-protection-controller,
    replicaset-controller,
    resourcequota-controller,
    root-ca-cert-publisher,
    service-account-controller,
    statefulset-controller
    ]

- macro: trusted_sa
  condition: (ka.target.name in (known_sa_list, user_known_sa_list))

# Detect creating a service account in the kube-system/kube-public namespace
- rule: Service Account Created in Kube Namespace
  desc: Detect any attempt to create a serviceaccount in the kube-system or kube-public namespaces
  condition: kevt and serviceaccount and kcreate and ka.target.namespace in (kube-system, kube-public) and response_successful and not trusted_sa
  exceptions:
  - name: accounts
    fields: [ka.target.namespace, ka.target.name]
  - name: account_only
    fields: ka.target.name
    comps: in
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  - name: users
    fields: [ka.target.namespace, ka.user.name]
    comps: [in, in]
  - name: accounts_user_prefix
    fields: [ka.target.namespace, ka.user.name]
    comps: [in, startswith]
    values:
    - [[kube-system], "system:node:ip-"]
  output: Service account created in kube namespace (user=%ka.user.name serviceaccount=%ka.target.name ns=%ka.target.namespace)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.5, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-3, NIST_800-53_AC-6, NIST_800-53_AU-2, NIST_800-53_CM-5, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.y, HITRUST_CSF_05.i, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k, MITRE, MITRE_T1036_masquerading, MITRE_T1609_container_administration_command, MITRE_TA0002_execution, MITRE_TA0005_defense_evasion]

# Detect any modify/delete to any ClusterRole starting with
# "system:". "system:coredns" is excluded as changes are expected in
# normal operation.
- rule: System ClusterRole Modified/Deleted
  desc: Detect any attempt to modify/delete a ClusterRole/Role starting with system
  condition: kevt and (role or clusterrole) and (kmodify or kdelete) and (ka.target.name startswith "system:") and not ka.target.name in (system:coredns, system:managed-certificate-controller)
  exceptions:
  - name: roles
    fields: [ka.target.namespace, ka.target.name]
  - name: roles_users
    fields: [ka.target.name, ka.user.name]
    values:
    - ["system:aggregated-metrics-reader", "system:serviceaccount:openshift-monitoring:cluster-monitoring-operator"]
  output: System ClusterRole/Role modified or deleted (user=%ka.user.name role=%ka.target.name ns=%ka.target.namespace action=%ka.verb)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.5, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-3, NIST_800-53_AC-6, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.y, HITRUST_CSF_05.i, HITRUST_CSF_10.j, MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

# Detect any attempt to create a ClusterRoleBinding to the cluster-admin user
# (exapand this to any built-in cluster role that does "sensitive" things)
- rule: Attach to cluster-admin Role
  desc: Detect any attempt to create a ClusterRoleBinding to the cluster-admin user
  condition: kevt and clusterrolebinding and kcreate and ka.req.binding.role=cluster-admin
  exceptions:
  - name: subjects
    fields: ka.req.binding.subjects
    comps: in
  output: Cluster Role Binding to cluster-admin role (user=%ka.user.name subject=%ka.req.binding.subjects)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.3, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-3, NIST_800-53_AU-6(8), NIST_800-53_CM-7(6), FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), ISO, ISO_27001, ISO_27001_A.6.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HIPAA_164.312(c), HIPAA_164.312(e), MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

- rule: ClusterRole With Wildcard Created
  desc: Detect any attempt to create a Role/ClusterRole with wildcard resources or verbs
  condition: kevt and (role or clusterrole) and kcreate and (ka.req.role.rules.resources intersects ("*") or ka.req.role.rules.verbs intersects ("*"))
  exceptions:
  - name: roles
    fields: ka.target.name
    comps: in
  - name: users
    fields: ka.user.name
    comps: in
  - name: users_contains
    fields: [ka.user.name]
    comps: [contains]
  output: Created Role/ClusterRole with wildcard (user=%ka.user.name role=%ka.target.name rules=%ka.req.role.rules)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC5.2, SOC2_CC6.3, PCI, PCI_DSS, PCI_DSS_10.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.5, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-3, NIST_800-53_AC-6, NIST_800-53_CM-7(6), FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), ISO, ISO_27001, ISO_27001_A.6.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(c), HIPAA_164.312(e), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.y, HITRUST_CSF_05.i, HITRUST_CSF_10.j, MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

- macro: writable_verbs
  condition: >
    (ka.req.role.rules.verbs intersects (create, update, patch, delete, deletecollection))

- rule: ClusterRole With Write Privileges Created
  desc: Detect any attempt to create a Role/ClusterRole that can perform write-related actions
  condition: kevt and (role or clusterrole) and kcreate and writable_verbs
  exceptions:
  - name: roles
    fields: ka.target.name
    comps: in
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  output: Created Role/ClusterRole with write privileges (user=%ka.user.name role=%ka.target.name rules=%ka.req.role.rules)
  priority: NOTICE
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.3, PCI, PCI_DSS, PCI_DSS_10.2, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.14.7, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.3, NIST_800-53, NIST_800-53_AC-6(9), NIST_800-53_AC-6(10), NIST_800-53_CM-3, NIST_800-53_SI-4, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_01.x, HITRUST_CSF_03.d, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ac, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_09.i, HITRUST_CSF_09.k, HITRUST_CSF_09.m, HITRUST_CSF_10.h, HITRUST_CSF_10.k, HITRUST_CSF_11.a, HITRUST_CSF_11.b, GDPR, GDPR_32.1, GDPR_32.2, MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

- rule: ClusterRole With Pod Exec Created
  desc: Detect any attempt to create a Role/ClusterRole that can exec to pods
  condition: kevt and (role or clusterrole) and kcreate and ka.req.role.rules.resources intersects ("pods/exec")
  exceptions:
  - name: roles
    fields: ka.target.name
    comps: in
  output: Created Role/ClusterRole with pod exec privileges (user=%ka.user.name role=%ka.target.name rules=%ka.req.role.rules)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.3, PCI, PCI_DSS, PCI_DSS_10.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.1.5, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-6, NIST_800-53_CM-7(6), FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(c), HIPAA_164.312(e), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.i, HITRUST_CSF_01.s, HITRUST_CSF_01.v, HITRUST_CSF_01.y, HITRUST_CSF_05.i, HITRUST_CSF_10.j, MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

# The rules below this point are less discriminatory and generally
# represent a stream of activity for a cluster. If you wish to disable
# these events, modify the following macro.
- macro: consider_activity_events
  condition: (k8s_audit_always_true)

# Activity events don't have exceptions. They do define an empty
# exceptions property just to avoid warnings when loading rules.

- macro: kactivity
  condition: (kevt and consider_activity_events)

- rule: K8s Deployment Created
  desc: Detect any attempt to create a deployment
  condition: (kactivity and kcreate and deployment and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Deployment Created (user=%ka.user.name deployment=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Deployment Deleted
  desc: Detect any attempt to delete a deployment
  condition: (kactivity and kdelete and deployment and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Deployment Deleted (user=%ka.user.name deployment=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Service Created
  desc: Detect any attempt to create a service
  condition: (kactivity and kcreate and service and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Service Created (user=%ka.user.name service=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Service Deleted
  desc: Detect any attempt to delete a service
  condition: (kactivity and kdelete and service and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Service Deleted (user=%ka.user.name service=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s ConfigMap Created
  desc: Detect any attempt to create a configmap
  condition: (kactivity and kcreate and configmap and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [=, startswith]
    values:
    - ["system:serviceaccount:openshift-operator-lifecycle-manager:collect-profiles", "olm-operator-heap-"]
    - ["system:serviceaccount:openshift-operator-lifecycle-manager:collect-profiles", "catalog-operator-heap-"]
  output: K8s ConfigMap Created (user=%ka.user.name configmap=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s ConfigMap Deleted
  desc: Detect any attempt to delete a configmap
  condition: (kactivity and kdelete and configmap and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [=, startswith]
    values:
    - ["system:serviceaccount:openshift-operator-lifecycle-manager:collect-profiles", "olm-operator-heap-"]
    - ["system:serviceaccount:openshift-operator-lifecycle-manager:collect-profiles", "catalog-operator-heap-"]
  - name: user_name_target_ns_startswith
    fields: [ka.user.name, ka.target.namespace]
    comps: [=, startswith]
    values:
    - ["system:serviceaccount:openshift-operator-lifecycle-manager:collect-profiles", "openshift-operator-lifecycle-manager"]
  output: K8s ConfigMap Deleted (user=%ka.user.name configmap=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Namespace Created
  desc: Detect any attempt to create a namespace
  condition: (kactivity and kcreate and namespace and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Namespace Created (user=%ka.user.name namespace=%ka.target.name resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Namespace Deleted
  desc: Detect any attempt to delete a namespace
  condition: (kactivity and non_system_user and kdelete and namespace and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Namespace Deleted (user=%ka.user.name namespace=%ka.target.name resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Serviceaccount Created
  desc: Detect any attempt to create a service account
  condition: (kactivity and kcreate and serviceaccount and response_successful)
  exceptions:
  - name: user_name
    fields: [ka.user.name]
    comps: [in]
  - name: account_only
    fields: [ka.target.name]
    comps: [in]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_prefix_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [startswith, in]
    values:
    - ["system:serviceaccount:openshift-operator-lifecycle-manager", [certified-operators, redhat-operators, redhat-marketplace, community-operators]]
  - name: user_name_prefix
    fields: [ka.user.name]
    comps: [startswith]
    values:
    - ["system:node:ip-"]
    - ["system:serviceaccount:openshift-controller-manager:"]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Serviceaccount Created (user=%ka.user.name serviceaccount=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, NIST_800-53_AU-2, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae]

- rule: K8s Serviceaccount Deleted
  desc: Detect any attempt to delete a service account
  condition: (kactivity and kdelete and serviceaccount and response_successful)
  exceptions:
  - name: user_name
    fields: [ka.user.name]
    comps: [in]
  - name: account_only
    fields: [ka.target.name]
    comps: [in]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Serviceaccount Deleted (user=%ka.user.name serviceaccount=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC6.2, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, NIST_800-53_AU-2, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae]

- rule: K8s Role/Clusterrole Created
  desc: Detect any attempt to create a cluster role/role
  condition: (kactivity and kcreate and (clusterrole or role) and response_successful)
  exceptions:
  - name: user_name
    fields: [ka.user.name]
    comps: [in]
  - name: user_name_prefix
    fields: [ka.user.name]
    comps: [startswith]
  - name: ka_auth_reason
    fields: [ka.auth.reason]
    comps: [contains]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Cluster Role Created (user=%ka.user.name role=%ka.target.name rules=%ka.req.role.rules resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, NIST_800-53_AU-2, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae]

- rule: K8s Role/Clusterrole Deleted
  desc: Detect any attempt to delete a cluster role/role
  condition: (kactivity and kdelete and (clusterrole or role) and response_successful)
  exceptions:
  - name: user_name
    fields: [ka.user.name]
    comps: [in]
  - name: user_name_prefix
    fields: [ka.user.name]
    comps: [startswith]
  - name: ka_auth_reason
    fields: [ka.auth.reason]
    comps: [contains]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Cluster Role Deleted (user=%ka.user.name role=%ka.target.name resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, NIST_800-53_AU-2, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae]

- rule: K8s Role/Clusterrolebinding Created
  desc: Detect any attempt to create a clusterrolebinding
  condition: (kactivity and kcreate and clusterrolebinding and response_successful)
  exceptions:
  - name: user_name
    fields: [ka.user.name]
    comps: [in]
  - name: user_name_prefix
    fields: [ka.user.name]
    comps: [startswith]
  - name: ka_auth_reason
    fields: [ka.auth.reason]
    comps: [contains]
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Cluster Role Binding Created (user=%ka.user.name binding=%ka.target.name subjects=%ka.req.binding.subjects role=%ka.req.binding.role resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), MITRE, MITRE_T1068_explotation_for_privilege_escalation, MITRE_TA0004_privilege_escalation]

- rule: K8s Role/Clusterrolebinding Deleted
  desc: Detect any attempt to delete a clusterrolebinding
  condition: (kactivity and kdelete and clusterrolebinding and response_successful)
  exceptions:
  - name: user_name_target_name
    fields: [ka.user.name, ka.target.name]
    comps: [in, in]
  - name: user_name_target_name_prefix
    fields: [ka.user.name, ka.target.name]
    comps: [in, startswith]
  output: K8s Cluster Role Binding Deleted (user=%ka.user.name binding=%ka.target.name resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(4), NIST_800-53_AC-3, FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(4), HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a)]

- rule: K8s Secret Created
  desc: Detect any attempt to create a secret. Service account tokens are excluded.
  condition: (kactivity and kcreate and secret and ka.target.namespace!=kube-system and non_system_user and response_successful)
  exceptions:
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  output: K8s Secret Created (user=%ka.user.name secret=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

- rule: K8s Secret Deleted
  desc: Detect any attempt to delete a secret Service account tokens are excluded.
  condition: (kactivity and kdelete and secret and ka.target.namespace!=kube-system and non_system_user and response_successful)
  exceptions:
  - name: user_suffix
    fields: [ka.user.name]
    comps: [endswith]
  - name: user_prefix
    fields: [ka.user.name]
    comps: [startswith]
  output: K8s Secret Deleted (user=%ka.user.name secret=%ka.target.name ns=%ka.target.namespace resp=%ka.response.code decision=%ka.auth.decision reason=%ka.auth.reason)
  priority: INFO
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.4.5, NIST_800-53, NIST_800-53_CM-5, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.b, HITRUST_CSF_10.j, HITRUST_CSF_10.k]

# This rule generally matches all events, and as a result is disabled
# by default. If you wish to enable these events, modify the
# following macro.
#  condition: (jevt.rawtime exists)
- macro: consider_all_events
  condition: (k8s_audit_never_true)

- macro: kall
  condition: (kevt and consider_all_events)

- rule: All K8s Audit Events
  desc: Match all K8s Audit Events
  condition: kall
  exceptions:
  output: K8s Audit Event received (user=%ka.user.name verb=%ka.verb uri=%ka.uri obj=%jevt.obj)
  priority: DEBUG
  source: k8s_audit
  tags: [k8s, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST, NIST_800-53, NIST_800-53_AU-2, FedRAMP, FedRAMP_AU-2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), HITRUST, HITRUST_CSF, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae]


# This macro disables following rule, change to k8s_audit_never_true to enable it
- macro: allowed_full_admin_users
  condition: (k8s_audit_always_true)

# This list includes some of the default user names for an administrator in several K8s installations
- list: full_admin_k8s_users
  items: ["admin", "kubernetes-admin", "kubernetes-admin@kubernetes", "kubernetes-admin@cluster.local", "minikube-user"]

# This rules detect an operation triggered by an user name that is
# included in the list of those that are default administrators upon
# cluster creation. This may signify a permission setting too broader.
# As we can't check for role of the user on a general ka.* event, this
# may or may not be an administrator. Customize the full_admin_k8s_users
# list to your needs, and activate at your discrection.

# # How to test:
# # Execute any kubectl command connected using default cluster user, as:
# kubectl create namespace rule-test

- rule: Full K8s Administrative Access
  desc: Detect any k8s operation by a user name that may be an administrator with full access.
  condition: >
    kevt
    and non_system_user
    and ka.user.name in (full_admin_k8s_users)
    and not allowed_full_admin_users
  exceptions:
  - name: user_names
    fields: ka.user.name
    comps: in
  output: K8s Operation performed by full admin user (user=%ka.user.name target=%ka.target.name/%ka.target.resource verb=%ka.verb uri=%ka.uri resp=%ka.response.code)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC5.2, SOC2_CC6.2, SOC2_CC7.1, PCI, PCI_DSS, PCI_DSS_2.1, NIST, NIST_800-171, NIST_800-171_3.1.1, NIST_800-171_3.1.2, NIST_800-190, NIST_800-190_3.3.1, NIST_800-53, NIST_800-53_AC-2, NIST_800-53_AC-2(12), NIST_800-53_AC-3, NIST_800-53_AC-6(2), NIST_800-53_CM-7(6), FedRAMP, FedRAMP_AC-2, FedRAMP_AC-2(12), FedRAMP_AC-6(2), ISO, ISO_27001, ISO_27001_A.6.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.310(a), HIPAA_164.310(b), HIPAA_164.312(a), HIPAA_164.312(c), HIPAA_164.312(e), HITRUST, HITRUST_CSF, HITRUST_CSF_01.c, HITRUST_CSF_01.q, MITRE, MITRE_T1078_valid_accounts, MITRE_T1078.001_default_accounts, MITRE_TA0004_privilege_escalation]

- macro: ingress
  condition: ka.target.resource=ingresses

- macro: ingress_tls
  condition: (jevt.value[/requestObject/spec/tls] exists)

# # How to test:
# # Create an ingress.yaml file with content:
# apiVersion: networking.k8s.io/v1beta1
# kind: Ingress
# metadata:
#   name: test-ingress
#   annotations:
#     nginx.ingress.kubernetes.io/rewrite-target: /
# spec:
#   rules:
#   - http:
#       paths:
#       - path: /testpath
#         backend:
#           serviceName: test
#           servicePort: 80
# # Execute: kubectl apply -f ingress.yaml

- rule: Ingress Object without TLS Certificate Created
  desc: Detect any attempt to create an ingress without TLS certification.
  condition: >
    (kactivity and kcreate and ingress and response_successful and not ingress_tls)
  exceptions:
  - name: ingresses
    fields: [ka.target.namespace, ka.target.name]
  output: >
    K8s Ingress Without TLS Cert Created (user=%ka.user.name ingress=%ka.target.name
    namespace=%ka.target.namespace)
  source: k8s_audit
  priority: WARNING
  tags: [k8s, network, SOC2, SOC2_CC6.7, PCI, PCI_DSS, PCI_DSS_4, NIST, NIST_800-171, NIST_800-171_3.13.8, NIST_800-53, NIST_800-53_AC-4(17), NIST_800-53_CM-3(6), NIST_800-53_SC-8, NIST_800-53_SC-12(3), NIST_800-53_SC-17, FedRAMP, FedRAMP_CM-3(6), FedRAMP_SC-8, ISO, ISO_27001, ISO_27001_A.10.1.1, ISO_27001_A.14.1.2, ISO_27001_A.18.1.5, HIPAA, HIPAA_164.308(a), HIPAA_164.310(b), HIPAA_164.312(c), HIPAA_164.312(e), HITRUST, HITRUST_CSF, HITRUST_CSF_01.n, HITRUST_CSF_09.m, HITRUST_CSF_09.s, HITRUST_CSF_09.v, HITRUST_CSF_09.x, HITRUST_CSF_09.y, HITRUST_CSF_10.d, HITRUST_CSF_10.g, GDPR, GDPR_5.1, MITRE, MITRE_T1190_exploit_public-facing_application, MITRE_TA0001_initial_access]

- macro: node
  condition: ka.target.resource=nodes

- macro: allow_all_k8s_nodes
  condition: (k8s_audit_always_true)

- list: allowed_k8s_nodes
  items: []

# # How to test:
# # Create a Falco monitored cluster with Kops
# # Increase the number of minimum nodes with:
# kops edit ig nodes
# kops apply --yes

- rule: Untrusted Node Successfully Joined the Cluster
  desc: >
    Detect a node successfully joined the cluster outside of the list of allowed nodes.
  condition: >
    kevt and node
    and kcreate
    and response_successful
    and not allow_all_k8s_nodes
  exceptions:
  - name: nodes
    fields: ka.target.name
    comps: in
    values: [allowed_k8s_nodes]
  output: Node not in allowed list successfully joined the cluster (user=%ka.user.name node=%ka.target.name)
  priority: ERROR
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, SOC2_CC7.2, NIST, NIST_800-190, NIST_800-190_3.3.5, NIST_800-53, NIST_800-53_AU-6(8), ISO, ISO_27001, ISO_27001_A.12.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(b), MITRE, MITRE_T1552_unsecured_credentials, MITRE_T1552.007_container_api, MITRE_T1609_container_administration_command, MITRE_TA0002_execution]

- rule: Untrusted Node Unsuccessfully Tried to Join the Cluster
  desc: >
    Detect an unsuccessful attempt to join the cluster for a node not in the list of allowed nodes.
  condition: >
    kevt and node
    and kcreate
    and not response_successful
    and not allow_all_k8s_nodes
  exceptions:
  - name: nodes
    fields: ka.target.name
    comps: in
    values: [allowed_k8s_nodes]
  output: Node not in allowed list tried unsuccessfully to join the cluster  (user=%ka.user.name node=%ka.target.name reason=%ka.response.reason)
  priority: WARNING
  source: k8s_audit
  tags: [k8s, SOC2, SOC2_CC7.1, SOC2_CC7.2, NIST, NIST_800-171, NIST_800-171_3.14.6, NIST_800-171_3.3.1, NIST_800-171_3.3.2, NIST_800-171_3.5.1, NIST_800-171_3.5.2, NIST_800-190, NIST_800-190_3.3.5, NIST_800-53, NIST_800-53_AU-2, NIST_800-53_IA-3, FedRAMP, FedRAMP_AU-2, ISO, ISO_27001, ISO_27001_A.12.1.2, HIPAA, HIPAA_164.308(a), HIPAA_164.312(a), HIPAA_164.312(b), HIPAA_164.312(d), HITRUST, HITRUST_CSF, HITRUST_CSF_01.j, HITRUST_CSF_01.k, HITRUST_CSF_01.p, HITRUST_CSF_01.s, HITRUST_CSF_06.i, HITRUST_CSF_09.aa, HITRUST_CSF_09.ab, HITRUST_CSF_09.ad, HITRUST_CSF_09.ae, HITRUST_CSF_09.m]
